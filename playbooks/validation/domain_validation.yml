---
# Domain Validation Playbook
#
# PLAYBOOK PURPOSE:
#   Validates that virtual machines have successfully joined the Active Directory domain
#   Performs comprehensive checks on domain membership, authentication, and configuration
#
# WORKFLOW:
#   1. Uses configuration passed via command line or vm_config.yml
#   2. Optionally displays debug information (when debug_mode is enabled)
#   3. Executes OS-specific domain validation checks
#   4. Reports validation results
#
# USAGE:
#   ansible-playbook -i inventory/hosts.ini playbooks/validation/domain_validation.yml \
#     -e '{"secrets": {"DOMAIN_ADMIN_USER": "admin@domain.com", "DOMAIN_ADMIN_PASSWORD": "password"}}'
#
# CONFIGURATION:
#   - Loads variables from inventory (group_vars and host_vars)
#   - Secrets passed via command line (-e) or from GitHub Actions workflow
#   - Required variables: domain_name, dns_server, linux_ou (from inventory group_vars)
#   - Required secrets: domain_admin_user, domain_admin_password

- name: Domain Join Validation
  hosts: "{{ target_hosts | default('domain_linux,domain_windows') }}"
  gather_facts: yes
  vars:
    # Use inventory variables directly from group_vars/host_vars
    config_domain_name: "{{ domain_name }}"
    config_domain_realm: "{{ domain_name | upper }}"
    config_domain_ou_linux: "{{ linux_ou | default('') }}"
    config_domain_ou_windows: "{{ windows_ou | default('') }}"
    config_vm_name: "{{ vm_name | default(inventory_hostname) }}"
    config_vm_ip: "{{ ansible_host | default('') }}"
    config_vm_os_type: "linux"
    config_vm_description: "Domain Join Validation"
    config_vm_network_dns_servers: "{{ dns_server | default('') }}"

    # Compute packages based on OS type
    config_domain_join_packages: "realmd,sssd,oddjob-mkhomedir,samba-common-tools,krb5-workstation"

  tasks:
    # OPTIONAL DEBUG OUTPUT - Display configuration for troubleshooting
    # Only executes when debug_mode=true is passed via command line (-e debug_mode=true)
    # Shows loaded configuration values to verify correct settings
    # Output: Displays domain name, admin user, and detected OS type
    - name: Display environment information
      debug:
        msg: |
          Configuration Loaded:
          Domain: {{ config_domain_name | default('NOT_SET') }}
          Admin User: {{ domain_admin_user | default('NOT_SET') }}
          System: {{ ansible_system | default('UNKNOWN') }}
          VM: {{ config_vm_name }} ({{ config_vm_ip }})
      tags: [validation, debug]
      when: debug_mode | default(false) | bool

    # DOMAIN VALIDATION EXECUTION - Run comprehensive domain join verification
    # Automatically detects OS type (Linux/Windows) and runs appropriate validation checks
    # For Linux: Validates realm membership, SSSD status, user authentication
    # For Windows: Validates domain membership, trust relationship, group policy
    # See roles/provisioning/join_validation/tasks/main.yml for detailed implementation
    - name: Execute domain validation checks
      include_role:
        name: provisioning/join_validation
      tags: validation

