---
# Test vCenter Connection
#
# PLAYBOOK PURPOSE:
#   Validates vCenter Server connectivity and permissions BEFORE VM provisioning
#   Runs on the Ansible control node to verify vCenter environment is accessible
#   Ensures vCenter credentials, datacenter, cluster, and datastore are valid
#
# WHY LOCALHOST:
#   This playbook runs on the Ansible control node (localhost), not target VMs
#   It validates the vCenter connection from where Ansible is executing:
#     - vCenter Server is accessible from control node
#     - Authentication credentials are valid
#     - Datacenter, cluster, and datastore exist
#     - Folder path is accessible
#     - User has required permissions for VM operations
#
# WORKFLOW:
#   1. Use vCenter configuration from inventory variables
#   2. Test connection to vCenter Server
#   3. Validate datacenter and cluster accessibility
#   4. Verify datastore exists and is accessible
#   5. Check folder permissions
#   6. Display comprehensive connectivity summary
#
# DEPENDENCIES:
#   - vmware.vmware_rest collection (for vCenter API operations)
#   - Or community.vmware collection (alternative)
#   - Valid SSL certificates or validate_certs: false
#
# USAGE:
#   ansible-playbook playbooks/validation/test_vcenter.yml -i inventory/hosts_resolved.ini
#
# REQUIRED CONFIGURATION:
#   All vCenter variables are provided via inventory host_vars:
#     vcenter_hostname: vcenter.example.com
#     vcenter_username: administrator@vsphere.local
#     vcenter_password: <password>
#     vcenter_port: 443
#     vcenter_validate_certs: false
#
# EXIT BEHAVIOR:
#   Fails immediately if vCenter connection or validation fails
#   No ignore_errors - vCenter access is critical for VM provisioning

- name: "Test vCenter Connection"
  hosts: localhost
  gather_facts: false
  connection: local
  tags:
    - vcenter
    - test
    - connection

  vars:
    # Map inventory variable names to role expected names
    # Credentials come from GitHub Secrets via workflow (group_vars/all.yml)
    vcenter_host: "{{ vcenter_hostname }}"
    vcenter_user: "{{ vcenter_username }}"
    vcenter_user_password: "{{ vcenter_password }}"
    # All other vCenter variables (vcenter_port, vcenter_validate_certs, vcenter_datacenter,
    # vcenter_cluster, vcenter_datastore, vcenter_folder) are used directly from inventory

  tasks:
    # CONFIGURATION VALIDATION - Ensure required vCenter settings are present
    # Validates that essential vCenter connection parameters are defined
    # Output: Success message or failure with details of missing configuration
    - name: "Validate vCenter configuration"
      assert:
        that:
          - vcenter_host is defined and vcenter_host != ""
          - vcenter_user is defined and vcenter_user != ""
          - vcenter_user_password is defined and vcenter_user_password != ""
        fail_msg: "vCenter configuration is incomplete. Required: vcenter_hostname, vcenter_username, vcenter_password"
        success_msg: "vCenter configuration validated successfully"
      tags:
        - vcenter
        - config

    # VCENTER CONNECTION VALIDATION - Execute comprehensive vCenter testing
    # Includes the vcenter_connection role which performs:
    #   - Variable validation (ensures all required fields are defined)
    #   - API connectivity test (verifies vCenter is reachable)
    #   - Authentication validation (tests credentials)
    #   - Resource verification (checks datacenter, cluster, datastore exist)
    #   - Permission checks (validates user has required privileges)
    # See roles/provisioning/vcenter_connection/tasks/main.yml for detailed implementation
    # Will fail playbook if any validation fails
    - name: "Include vCenter connection role"
      include_role:
        name: provisioning/vcenter_connection
      tags:
        - vcenter
        - connection

    # VALIDATION SUMMARY - Display successful vCenter connection test results
    # Shows all validated vCenter configuration parameters
    # Only displays if all previous validation tasks succeeded
    # Confirms the vCenter environment is ready for VM provisioning operations
    - name: "Test vCenter connectivity summary"
      debug:
        msg: |
          âœ… vCenter Connection Test Complete!
          
          Host: {{ vcenter_host }}
          Datacenter: {{ vcenter_datacenter }}
          Cluster: {{ vcenter_cluster }}
          Datastore: {{ vcenter_datastore }}
          Folder: {{ vcenter_folder }}
          
          All vCenter operations are ready!
      tags:
        - vcenter
        - summary
