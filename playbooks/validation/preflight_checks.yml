---
# Pre-flight Checks for VM Domain Joining
#
# PLAYBOOK PURPOSE:
#   Validates Ansible control node environment readiness BEFORE attempting domain joins
#   Runs locally on the control node to catch configuration issues early
#   Prevents wasted time attempting domain joins with invalid configurations
#
# WHY LOCALHOST:
#   This playbook runs on the Ansible control node (localhost), not target VMs
#   It validates the environment where Ansible is executing:
#     - Configuration files are present and valid
#     - Required Ansible collections are installed
#     - Network connectivity to domain controllers (when possible)
#     - DNS resolution works (when possible)
#     - File structure is correct
#
# WORKFLOW:
#   1. Load and validate project configuration variables
#   2. Test domain controller accessibility (HTTPS/LDAP ports)
#   3. Test DNS resolution for domain and domain controllers
#   4. Check Ansible collections availability
#   5. Validate file structure (roles, playbooks, inventory)
#   6. Display comprehensive pre-flight summary
#
# CONTAINERIZED ENVIRONMENTS:
#   Network and DNS checks may fail in Docker containers due to isolation
#   This is expected and does not prevent domain joins on target VMs
#   Target VMs will have proper network access when playbooks run
#
# USAGE:
#   ansible-playbook -i inventory/hosts.ini playbooks/validation/preflight_checks.yml \
#     -e '{"secrets": {"DOMAIN_ADMIN_USER": "admin@domain.com", "DOMAIN_ADMIN_PASSWORD": "password"}}'
#
# REQUIRED VARIABLES:
#   - domain_name: Domain name from inventory group_vars
#   - dns_server: DNS server from inventory group_vars
#   - All variables loaded from inventory structure
#
# EXIT BEHAVIOR:
#   Uses ignore_errors: true for network checks (expected failures in containers)
#   Will not fail playbook for network issues, only critical config problems

- name: "Pre-flight Environment Checks"
  hosts: runner
  gather_facts: false
  connection: local
  tags:
    - preflight
    - validation
  vars:
    # Use inventory variables from group_vars/host_vars
    config_domain_name: "{{ domain_name | default('') }}"
    config_domain_realm: "{{ domain_realm | default('') }}"
    config_domain_ou_linux: "{{ linux_ou | default('') }}"
    config_domain_ou_windows: "{{ windows_ou | default('') }}"
    config_vm_name: "{{ inventory_hostname }}"
    config_vm_ip: "{{ ansible_host | default('') }}"
    config_vm_os_type: "{{ 'linux' if groups['xxxx_xxx_linux'] is defined and inventory_hostname in groups['xxxx_xxx_linux'] else 'windows' }}"
    config_vm_network_dns_servers: "{{ dns_server | default('') }}"

  tasks:
    # CONFIGURATION LOADING - Load and parse project configuration
    # Transforms vm_config variables into standardized fact names
    # Splits DNS servers string into list for easier iteration
    # Output: domain_name, admin_user, dns_servers, domain_controllers, linux_group, windows_group
    - name: "Load project configuration from vm_config variables"
      set_fact:
        domain_name: "{{ config_domain_name }}"
        admin_user: "{{ ansible_user }}"
        dns_servers: "{{ config_vm_network_dns_servers }}"
        domain_controllers: "{{ config_vm_network_dns_servers.split(',') }}"
        linux_group: "linux_vms"
        windows_group: "windows_vms"
      tags:
        - config
        - setup

    # Verify all required configuration variables are defined
    # Fails immediately if critical configuration is missing
    # Prevents attempting domain joins with incomplete configuration
    - name: "Validate project configuration"
      assert:
        that:
          - domain_name is defined
          - admin_user is defined
          - dns_servers is defined
          - domain_controllers is defined
          - linux_group is defined
          - windows_group is defined
        fail_msg: "Project configuration incomplete - missing required variables"
        success_msg: "Project configuration validated successfully"
      tags:
        - validation
        - config

    # NETWORK CONNECTIVITY TESTS - Verify domain controller reachability
    # Test HTTPS connectivity to first domain controller
    # May fail in containerized environments due to network isolation
    # Output: dc_connectivity (status code if reachable)
    - name: "Test domain controller accessibility"
      uri:
        url: "https://{{ domain_controllers[0] }}"
        method: GET
        timeout: 15
        validate_certs: false
      ignore_errors: true
      register: dc_connectivity
      tags:
        - domain
        - connectivity

    # Test LDAP connectivity to domain controller on port 389
    # LDAP is critical for Active Directory operations
    # Output: dc_ldap_connectivity (status code if port is accessible)
    - name: "Test domain controller LDAP port"
      uri:
        url: "http://{{ domain_controllers[0] }}:389"
        method: GET
        timeout: 10
        validate_certs: false
      ignore_errors: true
      register: dc_ldap_connectivity
      tags:
        - domain
        - connectivity

    # Assert that at least one connectivity test succeeded
    # Accepts HTTPS (200, 401) or LDAP responses as success
    # Allows playbook to continue even if both fail (container environments)
    - name: "Validate domain controller accessibility"
      assert:
        that:
          - (dc_connectivity.status is defined and (dc_connectivity.status == 200 or dc_connectivity.status == 401)) or (dc_ldap_connectivity.status is defined and dc_ldap_connectivity.status == 200)
        fail_msg: "Cannot reach domain controller at {{ domain_controllers[0] }} (tried HTTPS and LDAP ports) - this may be expected in containerized environments"
        success_msg: "Domain controller accessibility verified at {{ domain_controllers[0] }}"
      ignore_errors: true
      tags:
        - validation
        - domain

    # DNS RESOLUTION TESTS - Verify domain name resolution
    # Uses block to group related DNS tests together
    - name: "Test DNS resolution for domain and domain controller"
      block:
        # Query DNS for the Active Directory domain name
        # Verifies that the domain FQDN resolves to IP address(es)
        # Output: dns_test (rc=0 if resolution successful)
        - name: "Test domain DNS resolution"
          command: "nslookup {{ domain_name }}"
          register: dns_test
          changed_when: false
          ignore_errors: true
          tags:
            - dns
            - resolution

        # Query DNS for the domain controller hostname/IP
        # Verifies that DC is resolvable from control node
        # Output: dc_dns_test (rc=0 if resolution successful)
        - name: "Test domain controller DNS resolution"
          command: "nslookup {{ domain_controllers[0] }}"
          register: dc_dns_test
          changed_when: false
          ignore_errors: true
          tags:
            - dns
            - domain_controllers

        # Assert both DNS queries succeeded
        # Failures are allowed in containerized environments
        - name: "Validate DNS resolution"
          assert:
            that:
              - dns_test.rc == 0
              - dc_dns_test.rc == 0
            fail_msg: "DNS resolution failed - this may be expected in containerized environments"
            success_msg: "DNS resolution successful for domain and domain controller"
          ignore_errors: true
          tags:
            - validation
            - dns

    # ANSIBLE COLLECTIONS CHECK - Verify required collections are installed
    # Lists all installed collections on control node
    # Required for Windows domain joins: community.windows
    # Output: collections_list (list of installed collections)
    - name: "Check Ansible collections availability"
      command: "ansible-galaxy collection list"
      register: collections_list
      changed_when: false
      tags:
        - collections
        - requirements

    # Informational message about collection validation
    # In containerized environments, collections are pre-installed in container image
    - name: "Validate collections (informational)"
      debug:
        msg: "Collections validation skipped - container will handle collection requirements"
      tags:
        - validation
        - collections

    # FILE STRUCTURE VALIDATION - Verify all required files and directories exist
    # Uses block to group related file checks together
    - name: "Validate file structure and accessibility"
      block:
        # Verify inventory directory exists
        # Output: inventory_check.stat.exists (boolean)
        - name: "Check inventory directory"
          stat:
            path: "inventory/"
          register: inventory_check
          tags:
            - inventory
            - files

        # Verify inventory template file exists
        # Output: hosts_file_check.stat.exists (boolean)
        - name: "Check inventory template file"
          stat:
            path: "inventory/hosts.ini.template"
          register: hosts_file_check
          tags:
            - inventory
            - files

        # Verify vm_config.yml configuration file exists
        # Output: vm_config_file_check.stat.exists (boolean)
        - name: "Check vm_config.yml file"
          stat:
            path: "vm_config.yml"
          register: vm_config_file_check
          tags:
            - config
            - files

        # Verify domain join role directory exists
        # Output: domain_join_role_check.stat.exists (boolean)
        - name: "Check domain join role"
          stat:
            path: "roles/provisioning/join_domain"
          register: domain_join_role_check
          tags:
            - roles
            - structure

        # Verify domain validation role directory exists
        # Output: domain_validation_role_check.stat.exists (boolean)
        - name: "Check domain validation role"
          stat:
            path: "roles/provisioning/join_validation"
          register: domain_validation_role_check
          tags:
            - roles
            - structure

        # Verify playbooks directory exists
        # Output: playbooks_check.stat.exists (boolean)
        - name: "Check playbooks directory"
          stat:
            path: "playbooks/provisioning/join_domain"
          register: playbooks_check
          tags:
            - playbooks
            - structure

        # Assert all required files and directories exist
        # Verifies complete project structure is present
        # Failures allowed in containerized environments with different structure
        - name: "Validate file structure"
          assert:
            that:
              - inventory_check.stat.exists and inventory_check.stat.isdir
              - hosts_file_check.stat.exists and hosts_file_check.stat.isfile
              - vm_config_file_check.stat.exists and vm_config_file_check.stat.isfile
              - domain_join_role_check.stat.exists and domain_join_role_check.stat.isdir
              - domain_validation_role_check.stat.exists and domain_validation_role_check.stat.isdir
              - playbooks_check.stat.exists and playbooks_check.stat.isdir
            fail_msg: "Required files or directories not found - this may be expected in containerized environments"
            success_msg: "File structure validated successfully"
          ignore_errors: true
          tags:
            - validation
            - files

    # PRE-FLIGHT SUMMARY - Display comprehensive results of all validation checks
    # Shows status of each validation category (domain, DNS, collections, files)
    # Provides context about expected failures in containerized environments
    # Helps operators understand environment readiness before proceeding with domain joins
    - name: "Display pre-flight summary"
      debug:
        msg: |
          Pre-flight Checks Complete!
          
          Domain: {{ domain_name }} ({{ 'OK' if ((dc_connectivity.status is defined and dc_connectivity.status in [200, 401]) or (dc_ldap_connectivity.status is defined and dc_ldap_connectivity.status == 200)) else 'WARNING - Container networking' }})
          DNS Resolution: {{ 'OK' if dns_test.rc == 0 else 'WARNING - Container networking' }}
          Domain Controller DNS: {{ 'OK' if dc_dns_test.rc == 0 else 'WARNING - Container networking' }}
          Collections: {{ 'OK' if collections_list.rc == 0 else 'FAILED' }}
          File Structure: {{ 'OK' if (inventory_check.stat.exists and hosts_file_check.stat.exists and vm_config_file_check.stat.exists) else 'WARNING - Container filesystem' }}
          
          Note: Network connectivity and filesystem warnings are expected in containerized environments.
          The actual domain join will be performed on the target VMs with proper network access.
      tags:
        - summary
        - completion